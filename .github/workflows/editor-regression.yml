name: Editor Regression

on:
  push:
    branches:
      - master
    paths:
      - "reading-garden-editor/**"
      - "scripts/editor-regression.sh"
      - "scripts/editor-regression.mjs"
      - ".github/workflows/editor-regression.yml"
  pull_request:
    paths:
      - "reading-garden-editor/**"
      - "scripts/editor-regression.sh"
      - "scripts/editor-regression.mjs"
      - ".github/workflows/editor-regression.yml"
  workflow_dispatch:
    inputs:
      pack_stats_selected_books:
        description: "Optional subset books for packStats, comma-separated (e.g. totto-chan,wave)"
        required: false
        default: "totto-chan,wave"
      pack_stats_require_valid_selection:
        description: "Fail when selected book IDs are invalid (true/false)"
        required: false
        default: "true"
      pack_stats_max_missing_assets:
        description: "Max allowed missing assets in subset-minimal (non-negative integer)"
        required: false
        default: "1"

jobs:
  editor-regression:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run Editor Regression
        env:
          EDITOR_REGRESSION_REPORT: tmp/editor-regression-report.json
          EDITOR_PACK_STATS_SELECTED_BOOKS: ${{ github.event_name == 'workflow_dispatch' && inputs.pack_stats_selected_books || 'totto-chan,wave' }}
          EDITOR_PACK_STATS_REQUIRE_VALID_SELECTION: ${{ github.event_name == 'workflow_dispatch' && inputs.pack_stats_require_valid_selection || 'true' }}
          EDITOR_PACK_STATS_MAX_MISSING_ASSETS: ${{ github.event_name == 'workflow_dispatch' && inputs.pack_stats_max_missing_assets || '1' }}
        run: ./scripts/editor-regression.sh

      - name: Summarize packStats
        if: always()
        run: |
          node <<'NODE'
          const fs = require("node:fs");
          const reportPath = "tmp/editor-regression-report.json";
          if (!fs.existsSync(reportPath)) process.exit(0);

          const report = JSON.parse(fs.readFileSync(reportPath, "utf8"));
          const stats = report.packStats
            || report.checks?.find((item) => item?.name === "pack-size-stats")?.details;
          if (!stats) process.exit(0);

          const selection = stats.selection || {};
          const selected = Array.isArray(stats.sampleSelectedBookIds) ? stats.sampleSelectedBookIds : [];
          const missing = Array.isArray(selection.missingBookIds) ? selection.missingBookIds : [];
          const invalidFormat = Array.isArray(selection.invalidFormatBookIds) ? selection.invalidFormatBookIds : [];
          const ratio = stats.comparePercent || {};
          const missingAssets = Number(stats.subsetMinimal?.missingAssets ?? 0);
          const missingAssetsAlert = missingAssets > 0 ? "warning" : "ok";
          const missingByCategory = stats.subsetMinimal?.missingAssetsByCategory || {};
          const categorySummary = Object.entries(missingByCategory)
            .map(([k, v]) => `${k}:${Number(v || 0)}`)
            .join(", ") || "(none)";
          const threshold = stats.missingAssetsThreshold || {};
          const thresholdText = threshold.enabled ? String(threshold.maxMissingAssets) : "disabled";
          const lines = [
            "### packStats Summary",
            "",
            `- mode: \`${selection.mode || "unknown"}\``,
            `- require valid selection: \`${String(stats.requireValidSelection ?? false)}\``,
            `- max missing-assets threshold: \`${thresholdText}\``,
            `- selected: \`${selected.join(", ") || "(none)"}\``,
            `- missing requested: \`${missing.join(", ") || "(none)"}\``,
            `- invalid format IDs: \`${invalidFormat.join(", ") || "(none)"}\``,
            `- missing assets (subset-minimal): ${missingAssets} (${missingAssetsAlert})`,
            `- missing assets by category: ${categorySummary}`,
            `- full bytes: ${stats.full?.totalBytes ?? 0}`,
            `- subset-balanced bytes: ${stats.subsetBalanced?.totalBytes ?? 0}`,
            `- subset-minimal bytes: ${stats.subsetMinimal?.totalBytes ?? 0}`,
            `- subset-balanced/full: ${ratio.subsetBalancedVsFull ?? 0}%`,
            `- subset-minimal/full: ${ratio.subsetMinimalVsFull ?? 0}%`,
          ];

          const summaryPath = process.env.GITHUB_STEP_SUMMARY;
          if (summaryPath) {
            fs.appendFileSync(summaryPath, `${lines.join("\n")}\n`, "utf8");
          }
          NODE

      - name: Upload Regression Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: editor-regression-report
          path: tmp/editor-regression-report.json
          if-no-files-found: warn
